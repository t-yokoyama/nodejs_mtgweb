<!doctype html>
<html>
  <head>
    <title>MTG web</title>


    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">

    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <script src="bootstrap-contextmenu.js"></script>

    <style>

      body {
        margin: 0px;
        padding: 0px;
        font: 13px Helvetica, Arial;
      }

      div {
        box-sizing: border-box;
      }

      div#window {
        height: 100%;
        width: 100%;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
        position: absolute;
      }

      div#battlefield_wrapper {
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
        position: absolute;
      }

      div.battlefield {
        height: 50%;
        width: 100%;
        position: relative;
      }

      div#my_battlefield { background-color: #ffcccc; }
      div#opp_battlefield { background-color: #ccffcc; }

      div.zone {
        background-color: #cccccc;
        height: 130px;
        width: 100px;
        position: absolute;
        padding: 0px;
        border-width: 1px;
        border-style: dashed;
      }

      div.zone_hover {
        outline: 4px solid #ff0000;
      }

      div#library { top: 20px; left: 140px; }
      div#graveyard { top: 20px; left: 20px; }
      div#exile { top: 20px; right: 20px; }

      div#hand {
        width: 100%;
        bottom: 0px;
        position: absolute;
      }

      img.card {
        background-color: #aaaaaa;
        height: 130px;
        width: 100px;
        position: absolute;
        border: 0px;
      }

      img.card_exiled {
        filter: gray;
        filter: grayscale(100%) brightness(50%);
        -webkit-filter: grayscale(100%) brightness(50%);
        -moz-filter: grayscale(100%) brightness(50%);
        -ms-filter: grayscale(100%) brightness(50%);
        -o-filter: grayscale(100%) brightness(50%);
      }

      img.card_hover {
        outline: 2px solid #ffff00;
      }


    </style>



    <script>

      function generateCard(cardId, image) {

        var imgElement = document.createElement("img");
        imgElement.id = cardId;
        imgElement.src = "images/cardback.jpg";
        imgElement.setAttribute("class", "card my_card rcmenu_target");
        imgElement.setAttribute("data-toggle", "context");

        document.getElementById("my_battlefield").appendChild(imgElement);

        var $card = $("#" + cardId);
        updateCardPosition($card, ZoneEnum.LIBRARY);
        $card.css("z-index", 10); // FIXME

        var cardEntry = {
          imgSrc : image,
          zone : ZoneEnum.LIBRARY,
          faceUp : false,
          tapped : false,
          flipped : false,
          transformed : false,
          numCounters : 0
        };

        g_directory.push(cardEntry);
        g_library.push(cardId);

      }

      function moveCardToZone(cardId, toZone, shiftHeld) {

        var $card = $("#" + cardId);

        // update card position (regardless of zone change)
        updateCardPosition($card, toZone);

        // check if we need to actually do anything else
        var fromZone = g_directory[cardId].zone;
        if (fromZone == toZone) {

          // if we're about to abort, and there's a possibility that
          // the user moved a 'hand' card around, refresh the hand 
          if (toZone == ZoneEnum.HAND) {
            refreshHand();
          }

          return;
        }

        var refHand = false;
        var refLibrary = false;
        var refGraveyard = false;
        var refExile = false;

        // remove card from its old zone array
        var pos;
        switch(fromZone) {

          case ZoneEnum.BATTLEFIELD:
            // do nothing
            break;

          case ZoneEnum.HAND:
            pos = g_hand.indexOf(cardId);
            g_hand.splice(pos, 1);
            refHand = true;
            break;

          case ZoneEnum.LIBRARY:
            pos = g_library.indexOf(cardId);
            g_library.splice(pos, 1);
            refLibrary = true;
            break;

          case ZoneEnum.GRAVEYARD:
            pos = g_graveyard.indexOf(cardId);
            g_graveyard.splice(pos, 1);
            refGraveyard = true;
            break;

          case ZoneEnum.EXILE:
            pos = g_exile.indexOf(cardId);
            g_exile.splice(pos, 1);
            $card.removeClass("card_exiled");
            refExile = true;
            break;
        }

        // switch on dest zone, then add to new array
        var turnFaceUp;
        switch(toZone) {

          case ZoneEnum.BATTLEFIELD:
            turnFaceUp = !shiftHeld;
            break;

          case ZoneEnum.HAND:
            g_hand.push(cardId);
            turnFaceUp = true;
            refHand = true;
            break;

          case ZoneEnum.LIBRARY:
            g_library.push(cardId);
            turnFaceUp = false;
            refLibrary = true;
            break;

          case ZoneEnum.GRAVEYARD:
            g_graveyard.push(cardId);
            turnFaceUp = true;
            refGraveyard = true;
            break;

          case ZoneEnum.EXILE:
            g_exile.push(cardId);
            turnFaceUp = !shiftHeld;
            $card.addClass("card_exiled");
            refExile = true;
            break;
        }

        // update directory
        g_directory[cardId].zone = toZone;
        g_directory[cardId].tapped = false;
        g_directory[cardId].flipped = false;
        g_directory[cardId].transformed = false;
        g_directory[cardId].numCounters = 0;

        // toggle face up/down as appropriate
        if (g_directory[cardId].faceUp && !turnFaceUp) {
          $card.attr("src", "images/cardback.jpg");
          g_directory[cardId].faceUp = false;
        }
        else if (!g_directory[cardId].faceUp && turnFaceUp) {
          $card.attr("src", g_directory[cardId].imgSrc);
          g_directory[cardId].faceUp = true;
        }

        // refresh display on both to/from zones
        if (refHand) {
          refreshHand();
        }
        if (refLibrary) {
          refreshLibrary();
        }
        if (refGraveyard) {
          refreshGraveyard();
        }
        if (refExile) {
          refreshExile();
        }

        // FIXME notify other client of state change
      }

      function updateCardPosition($card, toZone) {

        switch(toZone) {

          case ZoneEnum.HAND:
            $card.css("top", "auto");
            $card.css("bottom", $("#hand").css("bottom"));
            $card.css("left", "0px");
            $card.css("right", "auto");
            break;

          case ZoneEnum.LIBRARY:
            $card.css("top", $("#library").css("top"));
            $card.css("bottom", "auto");
            $card.css("left", $("#library").css("left"));
            $card.css("right", "auto");
            break;

          case ZoneEnum.GRAVEYARD:
            $card.css("top", $("#graveyard").css("top"));
            $card.css("bottom", "auto");
            $card.css("left", $("#graveyard").css("left"));
            $card.css("right", "auto");
            break;

          case ZoneEnum.EXILE:
            $card.css("top", $("#exile").css("top"));
            $card.css("bottom", "auto");
            $card.css("left", "auto");
            $card.css("right", $("#exile").css("right"));
            break;
        }
      }

      function refreshLibrary() {
        var offset = $("#library").offset();
        var z = offset.top * ZWIDTH + offset.left;
        var numCards = g_library.length;
        for (var i = 0; i < numCards; i++) {
          var $card = $("#" + g_library[i]);
          if (i == numCards - 1) {
            $card.show()
            $card.css("zIndex", z);
          }
          else if (i == numCards - 2) {
            $card.show()
            $card.css("zIndex", z - 1);
          }
          else {
            $card.hide()
          }
        }
      }

      function refreshGraveyard() {
        var offset = $("#graveyard").offset();
        var z = offset.top * ZWIDTH + offset.left;
        var numCards = g_graveyard.length;
        for (var i = 0; i < numCards; i++) {
          var $card = $("#" + g_graveyard[i]);
          if (i == numCards - 1) {
            $card.show()
            $card.css("zIndex", z);
          }
          else if (i == numCards - 2) {
            $card.show()
            $card.css("zIndex", z - 1);
          }
          else {
            $card.hide()
          }
        }
      }

      function refreshExile() {
        var offset = $("#exile").offset();
        var z = offset.top * ZWIDTH + offset.left;
        var numCards = g_exile.length;
        for (var i = 0; i < numCards; i++) {
          var $card = $("#" + g_exile[i]);
          if (i == numCards - 1) {
            $card.show()
            $card.css("zIndex", z);
          }
          else if (i == numCards - 2) {
            $card.show()
            $card.css("zIndex", z - 1);
          }
          else {
            $card.hide()
          }
        }
      }

      function refreshHand() {
        var offset = $("#hand").offset();
        var zbase = offset.top * ZWIDTH;
        var numCards = g_hand.length;
        var totalWidth = $("#hand").width() - 100;
        for (var i = 0; i < numCards; i++) {
          var $card = $("#" + g_hand[i]);
          var left = Math.floor(i * Math.min(totalWidth / (numCards - 1), 100));
          $card.css("left", left);
          $card.css("zIndex", zbase + left);
        }
      }

      function highlightCard($card) {
        $card.addClass("card_hover");
        $card.css("zIndex", ZTOP);
      }

      function unhighlightCard($card) {
        $card.removeClass("card_hover");
        var offset = $card.offset();
        $card.css("zIndex", offset.top * ZWIDTH + offset.left);
      }




      $(document).ready(function() {

        // global variables
        window.ZoneEnum = {
          BATTLEFIELD : 1,
          HAND : 2,
          LIBRARY : 3,
          GRAVEYARD : 4,
          EXILE : 5
        };

        window.ZTOP = 100000000;
        window.ZWIDTH = 10000;

        window.g_directory = [];
        window.g_library = [];
        window.g_graveyard = [];
        window.g_exile = [];
        window.g_hand = [];

        window.g_shiftHeld = false;
        window.g_rcmenuActive = false;
        window.g_rcCard;



        generateCard(0, "images/seraph_of_dawn.jpg");
        generateCard(1, "images/wild_hunger.jpg");
        generateCard(2, "images/myr_sire.jpg");
        generateCard(3, "images/affa_guard_hound.jpg");
        generateCard(4, "images/lightning_bolt.jpg");
        generateCard(5, "images/resounding_wave.jpg");
        generateCard(6, "images/forest.jpg");

        generateCard(7, "images/affa_guard_hound.jpg");
        generateCard(8, "images/lightning_bolt.jpg");
        generateCard(9, "images/resounding_wave.jpg");
        generateCard(10, "images/seraph_of_dawn.jpg");
        generateCard(11, "images/wild_hunger.jpg");
        generateCard(12, "images/myr_sire.jpg");
        generateCard(13, "images/affa_guard_hound.jpg");
        generateCard(14, "images/lightning_bolt.jpg");
        generateCard(15, "images/resounding_wave.jpg");
        
        generateCard(16, "images/forest_full.jpg");
        generateCard(17, "images/island_full.jpg");
        generateCard(18, "images/mountain_full.jpg");
        generateCard(19, "images/forest_full.jpg");

        $(".my_card").draggable({ grid: [5, 20],
                                  snap: ".zone",
                                  snapMode: "inner",
                                  snapTolerance: 10,
                                  containment: "#battlefield_wrapper"});


        $("#battlefield_wrapper").droppable({
          accept: ".my_card",
          drop: function( event, ui ) {
            var cardId = parseInt(ui.draggable.attr("id"));
            moveCardToZone(cardId,
                           ZoneEnum.BATTLEFIELD,
                           g_shiftHeld);
          }
        });
        
        $("#hand").droppable({
          accept: ".my_card",
          greedy: true,
          hoverClass: "zone_hover",
          drop: function( event, ui ) {
            var cardId = parseInt(ui.draggable.attr("id"));
            moveCardToZone(cardId,
                           ZoneEnum.HAND,
                           g_shiftHeld);
          }
        });

        $("#library").droppable({
          accept: ".my_card",
          greedy: true,
          hoverClass: "zone_hover",
          drop: function( event, ui ) {
            var cardId = parseInt(ui.draggable.attr("id"));
            moveCardToZone(cardId,
                           ZoneEnum.LIBRARY,
                           g_shiftHeld);
          }
        });

        $("#graveyard").droppable({
          accept: ".my_card",
          greedy: true,
          hoverClass: "zone_hover",
          drop: function( event, ui ) {
            var cardId = parseInt(ui.draggable.attr("id"));
            moveCardToZone(cardId,
                           ZoneEnum.GRAVEYARD,
                           g_shiftHeld);
          }
        });

        $("#exile").droppable({
          accept: ".my_card",
          greedy: true,
          hoverClass: "zone_hover",
          drop: function( event, ui ) {
            var cardId = parseInt(ui.draggable.attr("id"));
            moveCardToZone(cardId,
                           ZoneEnum.EXILE,
                           g_shiftHeld);
          }
        });

        window.onkeydown = function(e) {
          var key = e.which;
          switch(key) {
            case 16: // 'shift'
              g_shiftHeld = true;
              break;
          }
        }

        window.onkeyup = function(e) {
          var key = e.which;
          switch(key) {
            case 16: // 'shift'
              g_shiftHeld = false;
              break;
          }
        }

        $(".card").hover(
          function() {
            if (!g_rcmenuActive) {
              highlightCard($(this));
            }
          },
          function() {
            if (!g_rcmenuActive) {
              unhighlightCard($(this));
            }
          });

        $('.rcmenu_target').contextmenu({
          target: '#card_rcmenu',
          before: function (e, context) {
            g_rcmenuActive = true;
            g_rcCard = context;
            highlightCard(g_rcCard);
            
//            this.getMenu().find("li").eq(2).find('a').html("This was dynamically changed");
          },
          onItem: function (context, e) {
//            alert($(e.target).text());
          }
        });

        $('#card_rcmenu').on('hidden.bs.context', function (e) {
          g_rcmenuActive = false;
          unhighlightCard(g_rcCard);
        });




      });

    </script>
  </head>

  <body>

    <div id="window">
      <div id="battlefield_wrapper">
        <div class="battlefield" id="opp_battlefield">opp battlefield</div>
        <div class="battlefield" id="my_battlefield">my battlefield
          <div class="zone" id="library">library</div>
          <div class="zone" id="graveyard">graveyard</div>
          <div class="zone" id="exile">exile</div>
          <div class="zone" id="hand">hand</div>
        </div>
      </div>
    </div>

    <div id="card_rcmenu">
      <ul class="dropdown-menu" role="menu">
        <li><a tabindex="-1">Action</a></li>
        <li><a tabindex="-1">Another action</a></li>
        <li><a tabindex="-1">Something else here</a></li>
        <li class="divider"></li>
        <li><a tabindex="-1">Separated link</a></li>
      </ul>
    </div>



<!--
    <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>

    <script>
      var client_io = io();
      $('form').submit(function(){
        client_io.emit('chat message', $('#m').val());
        $('#m').val('');
        return false;
      });
      client_io.on('chat message', function(msg){
        $('#messages').append($('<li>').text(msg));
      });
    </script>
-->



  </body>
</html>
