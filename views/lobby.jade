doctype html
html
  head
    title Lobby
    script(src='https://code.jquery.com/jquery-1.9.1.min.js')
    script(src='/socket.io/socket.io.js')
    style.

      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }

      div#window { position: absolute; height: 100%; width: 100%; top: 0px; bottom: 0px; left: 0px; right: 0px; }
      div#sessions { position: absolute; height: 160px; top: 0px; left: 0px; right: 0px; overflow-x: auto; background-color: #cccccc; }
      div#chatcontainer { position: absolute; width: 100%; top: 160px; bottom: 0px; left: 0px; right: 0px; }
      div#userlist { position: absolute; top: 0px; bottom: 0px; left: 0px; width: 250px; overflow-y: auto; }
      div#chatcontainer2 { position: absolute; top: 0px; bottom: 0px; left: 250px; right: 0px; }
      div#chatmessages { position: absolute; top: 0px; bottom: 40px; left: 0px; right: 0px; overflow-y: scroll; }
      div#chatinput { position: absolute; height: 40px; bottom: 0px; left: 0px; right: 0px; background-color: #444444; }

      form#sendchat { position: absolute; height: 40px; bottom: 0px; left: 0px; right: 0px; padding: 3px; }
      form#sendchat input { position: absolute; width: 90%; left: 0px; right: 0px; border: 0; padding: 10px; margin-left: 3px; }
      form#sendchat button { position: absolute; right: 0px; width: 10%; border: none; padding: 10px; margin-right: 3px; background: #cccccc; }

      #users { list-style-type: none; margin: 0; padding: 0; background: #dddddd; }
      #users li { padding: 10px 20px; }
      li.header { font-weight: bold; background: #aaaaaa; }

      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(even) { background: #eeeeee; }
      li.system { font-style: italic; }

      .game { height: 140px; width: 200px; }
      .game_pending { background-color: #ffff44; }
      .game_accepted {}
      .game_ready {}
      .game_insession {}

      button { float: right }
      
  body
    div#window
      div#sessions
      div#chatcontainer
        div#userlist
          ul#users
            li.header Users
        div#chatcontainer2
          div#chatmessages
            ul#messages
          div#chatinput
            form#sendchat(action='')
              input#m(autocomplete='off')
              button Send

    script.

      $( document ).ready(function() {

        var client_io = io('/lobby');

        client_io.on('user_join', function(data){
          $('#users').append('<li id=u_' + data.username + '>' + data.username + ' <button id=c_' + data.userid + '>challenge</button></li>');
          $('html > head').append('<style>#u_' + data.username + ' { color: ' + data.color + '; }</style>');
          $('html > head').append('<style>.m_' + data.userid + ' { color: ' + data.color + '; }</style>');
          
          $('#c_' + data.userid).click(function(){
  
            // FIXME this is how we find out which user to send the invite to
            alert('from ' + '#{user.id}' + ' to ' + data.userid);
  
            client_io.emit('initiate_game', { from: '#{user.id}',
                                              to: data.userid });
            return false;
          });
  
          // TODO: prevent users from being able to challenge themselves
          // TODO: on the socketio.js end, receive the initiate_game request and route it to the proper opponent
          // TODO: create a local pending session
          // TODO: elsewhere on lobby.jade, receive the initiate_game request to create a session from the perspective of the opponent

          
        });

        client_io.on('user_exit', function(data){
          $('#u_' + data.username).remove();
        });

        client_io.on('chat_message', function(data){
          $('#messages').append('<li class=m_' + data.userid + '><strong>' + data.username + '</strong>: ' + data.msg + '</li>');



          // FIXME move this somewhere sensible
          // $('#sessions').append('<div class=game>game</div>');

        });
        
        client_io.on('sys_message', function(msg){
          $('#messages').append('<li class=system>' + msg + '</li>');
        });

        $('#sendchat').submit(function(){
          // FIXME don't send empty string
          client_io.emit('chat_message', { userid: '#{user.id}',
                                           username: '#{user.username}',
                                           msg: $('#m').val()});
          $('#m').val('');
          return false;
        });

        client_io.emit('user_join', {userid: '#{user.id}', username: '#{user.username}'});


      });
      



